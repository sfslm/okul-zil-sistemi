<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Okul Zil Kontrol Sistemi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }
        
        .login-box h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2rem;
        }
        
        .login-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .login-input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
        }
        
        .login-error {
            background: #f44336;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }
        
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            z-index: 1000;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 15px 15px 0 0;
        }
        
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        
        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            padding: 30px;
        }
        
        .panel {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .panel-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .slave-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #4CAF50;
        }
        
        .slave-item.offline { border-left-color: #f44336; opacity: 0.7; }
        .slave-item.teneffus { background: rgba(76,175,80,0.1); }
        .slave-item.ders { background: rgba(244,67,54,0.1); }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-primary { background: #2196F3; color: white; }
        
        .emergency-panel {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #ff5722, #d84315);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .emergency-btn {
            background: white;
            color: #ff5722;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
        }
        
        .schedule-editor {
            margin-top: 20px;
        }
        
        .schedule-item {
            display: grid;
            grid-template-columns: 80px 80px 120px 80px 60px;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .schedule-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .add-schedule-btn {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
        }
        
        .save-schedule-btn {
            width: 100%;
            padding: 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .location-selector {
            padding: 10px;
            font-size: 1rem;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <h2>ğŸ« Okul Zil Sistemi</h2>
            <div class="login-error" id="loginError"></div>
            <form id="loginForm">
                <input type="email" class="login-input" id="loginEmail" placeholder="E-posta" required>
                <input type="password" class="login-input" id="loginPassword" placeholder="Åifre" required>
                <button type="submit" class="login-btn">GÄ°RÄ°Å YAP</button>
            </form>
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <strong>GiriÅŸ:</strong><br>
                admin@okul.com / Admin123456
            </div>
        </div>
    </div>

    <button class="logout-btn" id="logoutBtn" style="display: none;" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ</button>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <h1>ğŸ« Okul Zil Kontrol Sistemi</h1>
            <p>Merkezi Kontrol Paneli</p>
        </div>

        <div class="main-content">
            <div class="panel">
                <div class="panel-title">
                    ğŸ“± BaÄŸlÄ± Cihazlar
                    <button class="btn btn-primary" onclick="refreshSlaves()">ğŸ”„</button>
                </div>
                <div id="slaveList"></div>
                
                <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <strong>ğŸ‘‘ Master Lokasyon AyarÄ±</strong>
                    <p style="font-size: 0.9rem; color: #666; margin: 8px 0;">Master'Ä±n hangi lokasyon programÄ±nÄ± takip edeceÄŸini seÃ§in:</p>
                    <select id="masterLocationSelector" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #2196F3; margin-bottom: 8px;">
                        <option value="">-- SeÃ§iniz --</option>
                    </select>
                    <button class="btn btn-primary" onclick="setMasterLocation()" style="width: 100%;">ğŸ’¾ Master Lokasyonunu Ayarla</button>
                    <div id="currentMasterLocation" style="margin-top: 8px; font-size: 0.85rem; color: #666;"></div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">
                    â° Zil ProgramÄ±
                    <select class="location-selector" id="locationSelector" onchange="loadSchedule()">
                        <option value="derslik">Derslik</option>
                        <option value="atolye">AtÃ¶lye</option>
                    </select>
                </div>
                <div class="schedule-editor" id="scheduleEditor"></div>
                <button class="add-schedule-btn" onclick="addScheduleItem()">â• Yeni Zil Ekle</button>
                <button class="save-schedule-btn" onclick="saveSchedule()">ğŸ’¾ ProgramÄ± Kaydet</button>
            </div>

            <div class="emergency-panel">
                <h2>ğŸš¨ KONTROL PANELÄ°</h2>
                <button class="emergency-btn" onclick="sendAllCommand('TENEFFUS')">ğŸŸ¢ HEPSÄ° TENEFFÃœS</button>
                <button class="emergency-btn" onclick="sendAllCommand('DERS')">ğŸ”´ HEPSÄ° DERS</button>
                <button class="emergency-btn" onclick="sendAllCommand('KAPALI')" style="background: #757575; color: white;">âš« HEPSÄ° KAPALI</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, onValue, update, set, get } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB4V-4SBpYCtblRKj9-9MjyfdSN-mWF60U",
            authDomain: "okul-zil-sistemi-7d402.firebaseapp.com",
            databaseURL: "https://okul-zil-sistemi-7d402-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "okul-zil-sistemi-7d402"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const authInstance = getAuth(app);
        let currentUser = null;
        let slaves = {};
        let currentSchedule = [];

        console.log('âœ… Firebase baÅŸarÄ±yla baÅŸlatÄ±ldÄ±');

        onAuthStateChanged(authInstance, (user) => {
            if (user) {
                currentUser = user;
                console.log('âœ… KullanÄ±cÄ± giriÅŸ yaptÄ±:', user.email);
                showMainInterface();
                listenToSlaves();
            } else {
                currentUser = null;
                console.log('âŒ KullanÄ±cÄ± Ã§Ä±kÄ±ÅŸ yaptÄ±');
                showLogin();
            }
        });

        window.login = async function(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            console.log('Login denemesi:', email);
            errorDiv.style.display = 'none';
            
            try {
                await signInWithEmailAndPassword(authInstance, email, password);
                console.log('âœ… GiriÅŸ baÅŸarÄ±lÄ±');
            } catch (error) {
                console.error('âŒ Login hatasÄ±:', error.code);
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'âŒ HatalÄ± email veya ÅŸifre!';
            }
        };

        window.logout = async function() {
            if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?')) {
                await signOut(authInstance);
            }
        };

        function showLogin() {
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
        }

        function showMainInterface() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';
        }

        function listenToSlaves() {
            const slavesRef = ref(database, 'slaves');
            onValue(slavesRef, (snapshot) => {
                slaves = snapshot.val() || {};
                displaySlaves();
            });
        }

        function displaySlaves() {
            const list = document.getElementById('slaveList');
            list.innerHTML = '';

            for (const [id, data] of Object.entries(slaves)) {
                const status = data.online ? 'online' : 'offline';
                const durumClass = (data.durum || 'ders').toLowerCase();
                const icon = data.tip === 'MASTER' ? 'ğŸ‘‘' : 'ğŸ“±';
                
                const div = document.createElement('div');
                div.className = `slave-item ${status} ${durumClass}`;
                div.innerHTML = `
                    <h3>${icon} ${id}</h3>
                    <p>Durum: ${data.durum || 'Bilinmiyor'} | Mod: ${data.mod || 'HYBRID'}</p>
                    <button class="btn btn-success" onclick="sendCommand('${id}', 'TENEFFUS')">ğŸŸ¢ TeneffÃ¼s</button>
                    <button class="btn btn-danger" onclick="sendCommand('${id}', 'DERS')">ğŸ”´ Ders</button>
                    <button class="btn" style="background: #757575; color: white;" onclick="sendCommand('${id}', 'KAPALI')">âš« Kapat</button>
                `;
                list.appendChild(div);
            }
        }

        window.sendCommand = async function(slaveId, command) {
            try {
                await update(ref(database, `slaves/${slaveId}`), { komut: command });
                console.log(`âœ… ${slaveId} â†’ ${command}`);
            } catch (error) {
                console.error('âŒ Komut hatasÄ±:', error);
            }
        };

        window.sendAllCommand = async function(command) {
            if (!confirm(`TÃ¼m cihazlara "${command}" gÃ¶nderilecek?`)) return;
            
            try {
                await update(ref(database, 'system'), {
                    broadcast: command,
                    broadcast_time: Date.now()
                });
                await update(ref(database, 'slaves/master'), { komut: command });
                alert('âœ… Komut gÃ¶nderildi!');
            } catch (error) {
                console.error('âŒ Broadcast hatasÄ±:', error);
            }
        };

        window.refreshSlaves = () => listenToSlaves();

        // Program yÃ¼kleme
        window.loadSchedule = async function() {
            const location = document.getElementById('locationSelector').value;
            try {
                const snapshot = await get(ref(database, `programs/${location}`));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    currentSchedule = data.ziller || [];
                } else {
                    currentSchedule = [];
                }
                displaySchedule();
            } catch (error) {
                console.error('Program yÃ¼klenemedi:', error);
            }
        };

        // ProgramÄ± gÃ¶rÃ¼ntÃ¼le
        function displaySchedule() {
            const editor = document.getElementById('scheduleEditor');
            editor.innerHTML = '';
            
            currentSchedule.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'schedule-item';
                div.innerHTML = `
                    <input type="number" class="schedule-input" value="${item.saat}" min="0" max="23" 
                           onchange="updateScheduleItem(${index}, 'saat', this.value)">
                    <input type="number" class="schedule-input" value="${item.dakika}" min="0" max="59" 
                           onchange="updateScheduleItem(${index}, 'dakika', this.value)">
                    <select class="schedule-input" onchange="updateScheduleItem(${index}, 'durum', this.value)">
                        <option value="DERS" ${item.durum === 'DERS' ? 'selected' : ''}>Ders</option>
                        <option value="TENEFFUS" ${item.durum === 'TENEFFUS' ? 'selected' : ''}>TeneffÃ¼s</option>
                        <option value="KAPALI" ${item.durum === 'KAPALI' ? 'selected' : ''}>KapalÄ±</option>
                    </select>
                    <button class="btn ${item.aktif ? 'btn-success' : ''}" style="padding: 5px;" 
                            onclick="toggleScheduleItem(${index})">
                        ${item.aktif ? 'âœ“ Aktif' : 'âœ— Pasif'}
                    </button>
                    <button class="btn btn-danger" style="padding: 5px;" onclick="deleteScheduleItem(${index})">ğŸ—‘ï¸</button>
                `;
                editor.appendChild(div);
            });
        }

        window.updateScheduleItem = function(index, field, value) {
            if (field === 'saat' || field === 'dakika') {
                currentSchedule[index][field] = parseInt(value);
            } else {
                currentSchedule[index][field] = value;
            }
        };

        window.toggleScheduleItem = function(index) {
            currentSchedule[index].aktif = !currentSchedule[index].aktif;
            displaySchedule();
        };

        window.deleteScheduleItem = function(index) {
            if (confirm('Bu zil zamanÄ±nÄ± silmek istediÄŸinize emin misiniz?')) {
                currentSchedule.splice(index, 1);
                displaySchedule();
            }
        };

        window.addScheduleItem = function() {
            currentSchedule.push({
                saat: 8,
                dakika: 30,
                durum: "DERS",
                aktif: true
            });
            displaySchedule();
        };

        window.saveSchedule = async function() {
            const location = document.getElementById('locationSelector').value;
            
            if (currentSchedule.length === 0) {
                alert('Program boÅŸ! En az bir zil zamanÄ± ekleyin.');
                return;
            }
            
            currentSchedule.sort((a, b) => {
                const timeA = a.saat * 60 + a.dakika;
                const timeB = b.saat * 60 + b.dakika;
                return timeA - timeB;
            });

            const programData = {
                zilSayisi: currentSchedule.length,
                ziller: currentSchedule
            };

            try {
                await set(ref(database, `programs/${location}`), programData);
                alert(`âœ… ${location.toUpperCase()} programÄ± kaydedildi!`);
            } catch (error) {
                console.error('Program kaydetme hatasÄ±:', error);
                alert('âŒ Program kaydedilemedi!');
            }
        };

        document.getElementById('loginForm').addEventListener('submit', login);
    </script>
</body>
</html>